<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Leafy â€¢ Leave Management</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --primary:#1e9c55; --primary-2:#2bc06d; --accent:#0d6efd; --danger:#dc3545;
    --muted:#e6eef0; --text:#0f172a;
    --panel: rgba(255,255,255,0.95); --shadow: 0 12px 30px rgba(2,6,23,0.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:linear-gradient(135deg,#eef6f2,#f3f6fb)}
  a{color:inherit;text-decoration:none}
  /* =========== Welcome =========== */
  #welcome{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:28px;text-align:center;z-index:40}
  .welcome-card{width:980px;max-width:94%;background:linear-gradient(180deg,rgba(255,255,255,0.92),rgba(255,255,255,0.86));border-radius:18px;padding:44px;box-shadow:var(--shadow);backdrop-filter:blur(8px)}
  .welcome-title{font-size:2.4rem;margin:0 0 10px;color:var(--primary);font-weight:800}
  .welcome-sub{color:#334155;font-size:1.05rem;margin:0 0 14px;line-height:1.45}
  .loading-text{display:inline-block;margin-top:12px;padding-right:14px;border-right:2px solid rgba(51,65,85,0.7);white-space:nowrap;overflow:hidden;animation:typing 3.2s steps(40,end) forwards, blink .8s infinite;font-weight:600;color:#475569}
  @keyframes typing{from{width:0}to{width:100%}} @keyframes blink{50%{border-color:transparent}}
  #welcome-login{position:fixed;right:20px;top:18px;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;border:none;font-weight:700;cursor:pointer;z-index:50}
  #welcome-login:hover{transform:scale(1.03)}
  /* =========== Shared =========== */
  .center-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:22px}
  .card{width:420px;max-width:96vw;background:var(--panel);border-radius:14px;padding:26px;box-shadow:var(--shadow);backdrop-filter: blur(6px)}
  h1{margin:0 0 14px;color:var(--primary)}
  label{font-weight:600;font-size:14px}
  input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);margin:8px 0 14px;font-size:14px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:700;transition:all .14s}
  .btn-primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#fff;box-shadow:0 8px 24px rgba(30,156,85,0.12)}
  .btn-muted{background:#f3f4f6;color:#111827}
  .btn-accent{background:var(--accent);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .inline{display:flex;gap:10px}
  .small{font-size:13px;color:#6b7280}
  .error{color:#b42318;min-height:18px}
  .hidden{display:none!important}
  /* =========== App layout =========== */
  .app{display:none;min-height:100vh;transition:opacity .3s}
  .topbar{position:sticky;top:0;background:rgba(255,255,255,0.9);backdrop-filter:blur(6px);box-shadow:0 1px 0 rgba(2,6,23,0.04);z-index:20}
  .topbar-inner{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{font-weight:800;color:var(--primary)}
  .user-pill{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:999px;background:rgba(15,23,42,0.04)}
  .user-pill img{width:36px;height:36px;border-radius:8px;object-fit:cover}
  .wrap{max-width:1200px;margin:20px auto;padding:0 12px;display:grid;grid-template-columns:240px 1fr;gap:18px;align-items:start}
  .sidebar{background:var(--panel);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
  .nav a{display:block;padding:10px;border-radius:8px;color:#0b1220;font-weight:700;margin-bottom:6px}
  .nav a.active,.nav a:hover{background:linear-gradient(90deg, rgba(30,156,85,0.08), rgba(13,110,253,0.04));color:var(--primary)}
  .panel{background:var(--panel);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:repeat(2,1fr)}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:900px){ .wrap{grid-template-columns:1fr} .grid-2,.grid-3{grid-template-columns:1fr} }
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid rgba(2,6,23,0.04);text-align:left}
  th{background:rgba(255,255,255,0.7);font-weight:700}
  .tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
  .tag-pending{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
  .tag-approved{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  .tag-rejected{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
  /* toast */
  #toastWrap{position:fixed;right:18px;bottom:18px;z-index:9999;display:flex;flex-direction:column;gap:10px}
  .toast{background:#07102a;color:white;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.4)}
</style>
</head>
<body>

<!-- Toast container -->
<div id="toastWrap"></div>

<!-- Welcome -->
<section id="welcome" aria-hidden="false">
  <div class="welcome-card">
    <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap;justify-content:space-between">
      <div style="flex:1 1 520px">
        <div class="welcome-title">ðŸŒ¿ Leafy â€¢ Leave Management</div>
        <p class="welcome-sub">Simplify leave applications, approvals and reporting â€” a clean, modern leave management demo for your capstone.</p>
        <div class="loading-text" id="welcomeLoading">Loading system modules...</div>
        <div style="margin-top:18px">
          <button class="btn btn-primary" id="ctaStart">Get started</button>
          <button class="btn btn-muted" onclick="openDocs()">Learn more</button>
        </div>
      </div>
      <div style="width:260px">
        <div style="background:linear-gradient(160deg,#fff,#f6fffb);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.04)">
          <strong>Demo accounts</strong>
          <div style="margin-top:8px;color:#475569;font-size:13px">
            admin@demo.com / Admin@123<br>
            hr@demo.com / Hr@12345<br>
            emp@demo.com / Emp@12345
          </div>
        </div>
      </div>
    </div>
  </div>
  <button id="welcome-login" title="Login" style="position:fixed;right:20px;top:18px;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;border:none;font-weight:700;cursor:pointer;z-index:60">Login</button>
</section>

<!-- AUTH -->
<section id="auth" class="center-wrap hidden" aria-hidden="true">
  <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;justify-content:center;max-width:980px;padding:10px">
    <div class="card" id="signupCard">
      <h1>Create Account</h1>
      <div class="error" id="signupErr"></div>
      <label>Email</label><input id="suEmail" type="email" placeholder="you@company.com"/>
      <label>Password</label><input id="suPass" type="password" placeholder="Min 6 characters"/>
      <label>Role</label>
      <select id="suRole"><option>Employee</option><option>Admin</option><option>HR</option><option>Finance</option><option>IT</option><option>Teacher</option></select>
      <div style="display:flex;gap:10px;margin-top:8px">
        <button class="btn btn-primary" id="btnSignup">Create</button>
        <button class="btn btn-muted" id="gotoLogin">I have an account</button>
      </div>
      <div class="small" style="margin-top:12px;color:#475569">You can create an account to apply leaves, update your profile and view your history.</div>
    </div>

    <div class="card hidden" id="loginCard">
      <h1>Login</h1>
      <div class="error" id="loginErr"></div>
      <label>Email</label><input id="liEmail" type="email" placeholder="you@company.com"/>
      <label>Password</label><input id="liPass" type="password" placeholder="Your password"/>
      <div style="display:flex;gap:10px">
        <button class="btn btn-primary" id="btnLogin">Login</button>
        <button class="btn btn-muted" id="gotoSignup">Create account</button>
      </div>
      <p class="small" style="margin-top:10px">Forgot your password? <span class="link" id="gotoForgot">Reset via email</span></p>
    </div>

    <div class="card hidden" id="forgotCard">
      <h1>Reset Password</h1>
      <div class="error" id="forgotErr"></div>
      <label>Enter your email</label><input id="fpEmail" type="email" placeholder="you@company.com"/>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-accent" id="btnForgot">Send reset link</button>
        <button class="btn btn-muted" id="cancelForgot">Cancel</button>
      </div>

      <div id="resetDemo" class="hidden" style="margin-top:12px">
        <label>Reset token (demo)</label><input id="resetToken" placeholder="Paste token here" />
        <label>New password</label><input id="resetPass" type="password" placeholder="New password" />
        <div style="margin-top:8px"><button class="btn btn-primary" id="btnReset">Update Password</button></div>
      </div>
      <div class="small" style="margin-top:10px;color:#475569">In demo mode the token may be returned in the API response for convenience.</div>
    </div>
  </div>
</section>

<!-- APP -->
<section id="app" class="app" aria-hidden="true" style="display:none">
  <div class="topbar"><div class="topbar-inner">
    <div class="brand">Leafy â€¢ Leave Management</div>
    <div style="display:flex;gap:12px;align-items:center">
      <div class="user-pill" id="headerUser" style="display:none">
        <img id="userAvatar" src="" alt="Avatar">
        <div style="text-align:left">
          <div id="userEmail" style="font-weight:700"></div>
          <div id="userRole" class="small"></div>
        </div>
      </div>
      <button class="btn btn-muted" id="logoutBtn" style="display:none">Logout</button>
    </div>
  </div></div>

  <div class="wrap">
    <aside class="sidebar">
      <nav class="nav" id="sideNav">
        <a href="#" data-route="dashboard" class="active" onclick="nav(event)">Dashboard</a>
        <a href="#" data-route="leave" onclick="nav(event)">Apply Leave</a>
        <a href="#" data-route="approvals" onclick="nav(event)">Approvals</a>
        <a href="#" data-route="reporting" onclick="nav(event)">Reporting Officers</a>
        <a href="#" data-route="admin" onclick="nav(event)">Admin Control</a>
        <a href="#" data-route="profile" onclick="nav(event)">My Profile</a>
      </nav>
    </aside>

    <main>
      <!-- small auth area (in-app quick login/signup) -->
      <div id="authArea" class="panel" style="max-width:760px;margin-bottom:18px">
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1 1 320px;">
            <h3>Sign in</h3>
            <div class="small">Existing users</div>
            <input id="liEmailMini" placeholder="email" type="email">
            <input id="liPassMini" placeholder="password" type="password">
            <div style="display:flex;gap:10px;margin-top:8px;">
              <button class="btn btn-primary" id="btnLoginMini">Login</button>
              <button class="btn btn-muted" id="showSignup">Create account</button>
            </div>
            <div style="margin-top:8px" class="small">Forgot password? <a href="#" id="showForgotMini">Reset</a></div>
            <div id="loginErrMini" class="error"></div>
          </div>

          <div style="flex:1 1 320px;">
            <h3>Create account</h3>
            <div class="small">New users</div>
            <input id="suEmailMini" placeholder="email" type="email">
            <input id="suPassMini" placeholder="password" type="password">
            <select id="suRoleMini" style="margin-top:8px">
              <option>Employee</option><option>Admin</option><option>HR</option>
            </select>
            <div style="display:flex;gap:10px;margin-top:8px">
              <button class="btn btn-primary" id="btnSignupMini">Create</button>
            </div>
            <div id="signupErrMini" class="error"></div>
          </div>
        </div>

        <div id="forgotBox" style="margin-top:18px; display:none;">
          <h3>Reset Password</h3>
          <div class="small">Enter your email and we will send a reset token</div>
          <input id="fpEmailMini" placeholder="email" type="email">
          <div style="margin-top:8px;display:flex;gap:10px">
            <button class="btn btn-primary" id="btnForgotMini">Send Reset Email</button>
            <button class="btn btn-outline" id="cancelForgotMini">Cancel</button>
          </div>
          <div id="forgotMsgMini" class="small" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="screen-dashboard" class="panel">
        <h2>Dashboard</h2>
        <div class="grid grid-3" style="margin-top:12px">
          <div class="panel"><h4>Total Employees</h4><div id="cardEmployees" style="font-size:28px;font-weight:800">0</div></div>
          <div class="panel"><h4>Pending Leaves</h4><div id="cardPending" style="font-size:28px;font-weight:800">0</div></div>
          <div class="panel"><h4>My Pending</h4><div id="cardMyPending" style="font-size:28px;font-weight:800">0</div></div>
        </div>
        <div class="panel" style="margin-top:12px">
          <h4>My Leaves: This Month</h4>
          <div id="chartWrap" style="width:min(520px,100%);height:300px"><canvas id="empPie"></canvas></div>
        </div>
      </section>

      <!-- APPLY LEAVE -->
      <section id="screen-leave" class="panel hidden">
        <h2>Apply Leave</h2>
        <div class="error" id="leaveErr"></div>
        <div class="grid grid-2">
          <div>
            <label>Leave Type</label>
            <select id="lvType"><option value="">Select</option><option>Casual</option><option>Sick</option><option>Emergency</option><option>Earned</option></select>
          </div>
          <div>
            <label>Days</label>
            <input id="lvDays" type="number" min="1" max="30" placeholder="e.g., 2">
          </div>
        </div>
        <label>Reason</label>
        <textarea id="lvReason" rows="3"></textarea>
        <div style="margin-top:8px"><button class="btn btn-primary" id="btnSubmitLeave">Submit</button></div>
        <div class="panel" style="margin-top:12px">
          <h4>My Recent Requests</h4>
          <table><thead><tr><th>Date</th><th>Type</th><th>Days</th><th>Status</th></tr></thead><tbody id="myLeavesTbody"></tbody></table>
        </div>
      </section>

      <!-- APPROVALS -->
      <section id="screen-approvals" class="panel hidden">
        <h2>Approvals</h2>
        <div id="apprInfo" class="small"></div>
        <table style="margin-top:10px"><thead><tr><th>Employee</th><th>Type</th><th>Days</th><th>Submitted</th><th>Status</th><th>Action</th></tr></thead><tbody id="apprTbody"></tbody></table>
      </section>

      <!-- REPORTING -->
      <section id="screen-reporting" class="panel hidden">
        <h2>Assign Reporting Officers</h2>
        <div class="small">Select an officer for each employee.</div>
        <table style="margin-top:10px"><thead><tr><th>Employee</th><th>Role</th><th>Reporting Officer</th></tr></thead><tbody id="reportingTbody"></tbody></table>
        <div style="margin-top:10px"><button class="btn btn-primary" id="btnSaveReporting">Save Assignments</button></div>
      </section>

      <!-- ADMIN -->
      <section id="screen-admin" class="panel hidden">
        <h2>Admin Control Panel</h2>
        <div class="panel">
          <h4>Role Permissions</h4>
          <div id="permMatrix" class="small"></div>
          <div style="margin-top:10px"><button class="btn btn-primary" id="btnSavePerms">Save Permissions</button></div>
        </div>
        <div class="panel" style="margin-top:12px">
          <h4>Users</h4>
          <table><thead><tr><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody id="usersTbody"></tbody></table>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="screen-profile" class="panel hidden">
        <h2>My Profile</h2>
        <div class="grid grid-2">
          <div>
            <label>Photo</label>
            <input id="pfPhoto" type="file" accept="image/*">
            <img id="pfPreview" src="" style="width:120px;height:120px;border-radius:12px;object-fit:cover;margin-top:8px" alt="">
          </div>
          <div>
            <label>Full name</label>
            <input id="pfName">
            <label>Phone</label>
            <input id="pfPhone">
            <label>Address</label>
            <textarea id="pfAddr" rows="3"></textarea>
            <div style="margin-top:8px"><button class="btn btn-primary" id="btnSaveProfile">Save Profile</button></div>
          </div>
        </div>
      </section>

    </main>
  </div>
</section>

<script>
/* ================= CONFIG ================= */
const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:5000/api' : '/api';
const authTokenKey = 'lms_token';
let CURRENT_USER = null;
let PERMS = {};
let pieChart = null;

/* ================= HELPERS ================= */
function toast(msg, t=2600){
  const wrap = document.getElementById('toastWrap');
  const el = document.createElement('div'); el.className='toast'; el.textContent = msg;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.transition='opacity .3s'; el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, t);
}
const $ = sel => document.querySelector(sel);

/* API wrapper */
async function api(path, opts = {}){
  const headers = opts.headers || {};
  if(!headers['Content-Type']) headers['Content-Type'] = 'application/json';
  const token = localStorage.getItem(authTokenKey);
  if(token) headers['Authorization'] = 'Bearer ' + token;
  opts.headers = headers;
  try {
    const res = await fetch(API_BASE + path, opts);
    const json = await res.json().catch(()=>({}));
    return { status: res.status, data: json };
  } catch (e) {
    return { status: 0, data: { ok:false, msg:'Network error' } };
  }
}

/* UI helpers */
function show(el){ el.classList.remove('hidden'); el.style.display = el.dataset.inline === 'flex' ? 'flex' : 'block'; }
function hide(el){ el.classList.add('hidden'); el.style.display = 'none'; }

/* ============== Welcome -> Auth ============== */
document.getElementById('welcome-login').addEventListener('click', openAuth);
document.getElementById('ctaStart').addEventListener('click', openAuth);
function openDocs(){ window.open('https://en.wikipedia.org/wiki/Leave_of_absence','_blank'); }
function openAuth(){
  document.getElementById('welcome').classList.add('hidden');
  document.getElementById('auth').classList.remove('hidden');
  document.getElementById('auth').style.display = 'flex';
  showLogin();
  window.scrollTo(0,0);
}

/* ============== Auth UI binds ============== */
$('#gotoLogin').addEventListener('click', ()=>{ $('#signupCard').classList.add('hidden'); $('#loginCard').classList.remove('hidden'); });
$('#gotoSignup').addEventListener('click', ()=>{ $('#loginCard').classList.add('hidden'); $('#signupCard').classList.remove('hidden'); });
$('#gotoForgot').addEventListener('click', ()=>{ $('#loginCard').classList.add('hidden'); $('#forgotCard').classList.remove('hidden'); });
$('#cancelForgot').addEventListener('click', ()=>{ $('#forgotCard').classList.add('hidden'); $('#loginCard').classList.remove('hidden'); });

function showLogin(){ $('#signupCard').classList.add('hidden'); $('#forgotCard').classList.add('hidden'); $('#loginCard').classList.remove('hidden'); }
function showSignup(){ $('#loginCard').classList.add('hidden'); $('#forgotCard').classList.add('hidden'); $('#signupCard').classList.remove('hidden'); }
function showForgot(){ $('#loginCard').classList.add('hidden'); $('#signupCard').classList.add('hidden'); $('#forgotCard').classList.remove('hidden'); }

/* ============== Auth actions ============== */
/* Signup */
$('#btnSignup').addEventListener('click', async ()=>{
  $('#signupErr').textContent = '';
  const email = $('#suEmail').value.trim().toLowerCase();
  const pass = $('#suPass').value;
  const role = $('#suRole').value;
  if(!email || !pass){ $('#signupErr').textContent='Email and password required'; return; }
  const {status, data} = await api('/signup', { method:'POST', body: JSON.stringify({ email, password: pass, role }) });
  if((status===200 && data.ok) || status===201){ toast('Account created â€” please login'); $('#suEmail').value=''; $('#suPass').value=''; showLogin(); }
  else $('#signupErr').textContent = data.msg || 'Error';
});

/* Login */
$('#btnLogin').addEventListener('click', async ()=>{
  $('#loginErr').textContent = '';
  const email = $('#liEmail').value.trim().toLowerCase();
  const pass = $('#liPass').value;
  const {status, data} = await api('/login', { method:'POST', body: JSON.stringify({ email, password: pass }) });
  if(status===200 && data.ok){
    localStorage.setItem(authTokenKey, data.access_token);
    CURRENT_USER = data.user;
    afterLogin();
    toast('Welcome back');
  } else {
    $('#loginErr').textContent = data.msg || 'Login failed';
  }
});

/* Forgot */
$('#btnForgot').addEventListener('click', async ()=>{
  $('#forgotErr').textContent = '';
  const email = $('#fpEmail').value.trim().toLowerCase();
  const {status, data} = await api('/forgot', { method:'POST', body: JSON.stringify({ email }) });
  if(status===200 && data.ok){
    if(data.reset_token){ $('#resetToken').value = data.reset_token; $('#resetDemo').classList.remove('hidden'); }
    $('#resetDemo').classList.remove('hidden');
    toast('Reset token created (demo)');
  } else {
    $('#forgotErr').textContent = data.msg || 'Error sending reset';
  }
});

/* Reset */
$('#btnReset').addEventListener('click', async ()=>{
  $('#forgotErr').textContent = '';
  const token = $('#resetToken').value.trim();
  const pw = $('#resetPass').value;
  const {status, data} = await api('/reset', { method:'POST', body: JSON.stringify({ token, password: pw }) });
  if(status===200 && data.ok){ toast('Password updated'); $('#resetDemo').classList.add('hidden'); showLogin(); }
  else $('#forgotErr').textContent = data.msg || 'Reset failed';
});

/* Mini auth area buttons */
$('#btnSignupMini')?.addEventListener('click', async ()=>{
  const email = $('#suEmailMini').value.trim().toLowerCase(), pass = $('#suPassMini').value, role = $('#suRoleMini').value;
  if(!email||!pass){ $('#signupErrMini').textContent='Email and password required'; return; }
  const {status,data} = await api('/signup', { method:'POST', body: JSON.stringify({ email, password: pass, role }) });
  if((status===200 && data.ok) || status===201){ toast('Account created â€” login'); $('#suEmailMini').value=''; $('#suPassMini').value=''; } else $('#signupErrMini').textContent = data.msg || 'Error';
});
$('#btnLoginMini')?.addEventListener('click', ()=> $('#btnLogin').click());
$('#btnForgotMini')?.addEventListener('click', async ()=>{
  const email = $('#fpEmailMini').value.trim().toLowerCase();
  const {status,data} = await api('/forgot', { method:'POST', body: JSON.stringify({ email }) });
  if(status===200 && data.ok){ $('#forgotMsgMini').textContent='Reset email sent'; if(data.reset_token){ $('#resetToken').value = data.reset_token; $('#resetDemo').classList.remove('hidden'); } } else $('#forgotMsgMini').textContent = data.msg || 'Error';
});
$('#showSignup').addEventListener('click', ()=>{ $('#suEmailMini').focus(); });
$('#showForgotMini').addEventListener('click', ()=>{ $('#forgotBox').style.display='block'; });

/* ============== After login ============== */
async function afterLogin(){
  // fetch me (ensure freshest)
  const me = await api('/me', { method:'GET' });
  if(me.status===200 && me.data.ok) CURRENT_USER = me.data.user || CURRENT_USER;
  if(!CURRENT_USER){ toast('Failed to load user'); return; }
  // hide auth/welcome, show app
  $('#auth').classList.add('hidden'); $('#welcome').classList.add('hidden');
  $('#app').style.display = 'block';
  $('#headerUser').style.display = 'flex'; $('#logoutBtn').style.display = 'inline-flex';
  $('#userEmail').textContent = CURRENT_USER.email; $('#userRole').textContent = CURRENT_USER.role;
  $('#userAvatar').src = CURRENT_USER.profile?.photo || `https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(CURRENT_USER.email)}`;
  await loadPermissionsAndRender();
  await loadAllForUser();
}

/* On initial boot: check token */
(async function boot(){
  const token = localStorage.getItem(authTokenKey);
  if(token){
    const me = await api('/me', { method:'GET' });
    if(me.status===200 && me.data.ok){ CURRENT_USER = me.data.user; afterLogin(); return; }
    localStorage.removeItem(authTokenKey);
  }
  // show welcome (default)
})();

/* ============== Permissions & nav ============== */
async function loadPermissionsAndRender(){
  const {status, data} = await api('/permissions', { method:'GET' });
  if(status===200 && data.ok) PERMS = data.perms || {};
  else PERMS = { Admin:['approve_leave','assign_reporting','manage_permissions','view_dashboard','apply_leave','manage_users'], HR:['approve_leave','assign_reporting','view_dashboard','apply_leave'], Employee:['apply_leave','view_dashboard'] };
  document.querySelectorAll('#sideNav a').forEach(a=>{
    const r = a.dataset.route;
    let allowed = true;
    if(r==='leave') allowed = (PERMS[CURRENT_USER.role]||[]).includes('apply_leave');
    if(r==='approvals') allowed = (PERMS[CURRENT_USER.role]||[]).includes('approve_leave');
    if(r==='reporting') allowed = (PERMS[CURRENT_USER.role]||[]).includes('assign_reporting');
    if(r==='admin') allowed = (PERMS[CURRENT_USER.role]||[]).includes('manage_permissions');
    a.style.display = allowed ? 'block' : 'none';
  });
}

/* ============== Navigation ============== */
window.nav = function nav(e){ e.preventDefault(); const target = e.currentTarget || e.target; const route = target.dataset.route; document.querySelectorAll('#sideNav a').forEach(a=>a.classList.remove('active')); target.classList.add('active'); showScreen(route); }
function showScreen(route){
  const screens = ['dashboard','leave','approvals','reporting','admin','profile'];
  screens.forEach(r => { const el = document.getElementById('screen-'+r); if(el) el.classList.add('hidden'); });
  document.getElementById('screen-'+route).classList.remove('hidden');
  if(route==='dashboard') renderDashboard();
  if(route==='leave') renderMyLeaves();
  if(route==='approvals') renderApprovals();
  if(route==='reporting') renderReporting();
  if(route==='admin') renderAdmin();
  if(route==='profile') renderProfile();
}

/* ============== Data loaders & UI ============== */
async function loadAllForUser(){
  await loadPermissionsAndRender();
  renderDashboard();
  renderMyLeaves();
  renderApprovals();
  renderReporting();
  renderAdmin();
  renderProfile();
}

/* Dashboard */
async function renderDashboard(){
  const {status:us, data:ud} = await api('/users', { method:'GET' });
  $('#cardEmployees').textContent = (us===200 && ud.ok) ? ud.users.length : 'â€”';
  const showAll = (PERMS[CURRENT_USER.role]||[]).includes('approve_leave') ? 'true' : 'false';
  const {data:ld} = await api('/leaves?all='+showAll, { method:'GET' });
  const leaves = (ld && ld.leaves) ? ld.leaves : [];
  $('#cardPending').textContent = leaves.filter(l=>l.status==='Pending').length;
  $('#cardMyPending').textContent = leaves.filter(l=>l.userId===CURRENT_USER.id && l.status==='Pending').length;
  const myMonthLeaves = leaves.filter(l=>l.userId===CURRENT_USER.id && l.month===new Date().toISOString().slice(0,7) && l.status!=='Rejected');
  const daysTaken = myMonthLeaves.reduce((s,l)=>s + (Number(l.days)||0),0);
  const monthlyQuota = 2;
  const daysLeft = Math.max(0, monthlyQuota - daysTaken);
  const ctx = document.getElementById('empPie').getContext('2d');
  if(window.pieChart) window.pieChart.destroy();
  window.pieChart = new Chart(ctx, { type:'pie', data:{ labels:['Taken','Left'], datasets:[{ data:[daysTaken, daysLeft], backgroundColor:['#1e9c55','#cfd8e3'] }] }, options:{ responsive:true, maintainAspectRatio:false } });
}

/* My leaves */
async function renderMyLeaves(){
  const {data:ld} = await api('/leaves', { method:'GET' });
  const leaves = (ld && ld.leaves) ? ld.leaves : [];
  const my = leaves.filter(l=>l.userId===CURRENT_USER.id).sort((a,b)=> b.created.localeCompare(a.created));
  const tbody = $('#myLeavesTbody'); tbody.innerHTML = '';
  for(const l of my.slice(0,20)){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(l.created).toLocaleDateString()}</td><td>${l.type}</td><td>${l.days}</td><td>${statusTag(l.status)}</td>`;
    tbody.appendChild(tr);
  }
}

/* Submit leave */
$('#btnSubmitLeave').addEventListener('click', async ()=>{
  $('#leaveErr').textContent = '';
  const type = $('#lvType').value, days = Number($('#lvDays').value), reason = $('#lvReason').value.trim();
  if(!type){ $('#leaveErr').textContent = 'Select leave type'; return; }
  if(!days || days<=0){ $('#leaveErr').textContent = 'Enter valid days'; return; }
  const {status,data} = await api('/leaves', { method:'POST', body: JSON.stringify({ type, days, reason }) });
  if(status===200 && data.ok){ renderMyLeaves(); renderDashboard(); toast(data.leave.status==='Approved'?'Emergency auto-approved':'Leave submitted'); $('#lvType').value=''; $('#lvDays').value=''; $('#lvReason').value=''; }
  else $('#leaveErr').textContent = data.msg || 'Error';
});

/* Approvals */
function statusTag(s){ if(s==='Pending') return `<span class="tag tag-pending">Pending</span>`; if(s==='Approved') return `<span class="tag tag-approved">Approved</span>`; return `<span class="tag tag-rejected">Rejected</span>`; }
async function renderApprovals(){
  if(!(PERMS[CURRENT_USER.role]||[]).includes('approve_leave')){ $('#apprInfo').textContent = 'You do not have permission to approve leaves.'; $('#apprTbody').innerHTML = ''; return; }
  $('#apprInfo').textContent = 'Approve or reject pending requests.';
  const {data:ld} = await api('/leaves?all=true', { method:'GET' });
  const leaves = (ld && ld.leaves) ? ld.leaves : [];
  const tbody = $('#apprTbody'); tbody.innerHTML = '';
  for(const l of leaves){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${l.email||''}</td><td>${l.type}</td><td>${l.days}</td><td>${new Date(l.created).toLocaleString()}</td><td>${statusTag(l.status)}</td><td>${l.status==='Pending'?actionBtns(l):'â€”'}</td>`;
    tbody.appendChild(tr);
  }
}
function actionBtns(l){ return `<div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="approve('${l.id}')">Approve</button><button class="btn btn-muted" onclick="reject('${l.id}')">Reject</button></div>`; }
window.approve = async function(id){ const {status,data} = await api(`/leaves/${id}`, { method:'PUT', body: JSON.stringify({ action:'approve' }) }); if(status===200 && data.ok){ renderApprovals(); renderDashboard(); toast('Approved'); } else toast('Error'); }
window.reject = async function(id){ const {status,data} = await api(`/leaves/${id}`, { method:'PUT', body: JSON.stringify({ action:'reject' }) }); if(status===200 && data.ok){ renderApprovals(); renderDashboard(); toast('Rejected'); } else toast('Error'); }

/* Reporting */
let reportingAssignments = {};
async function renderReporting(){
  if(!(PERMS[CURRENT_USER.role]||[]).includes('assign_reporting')){ $('#screen-reporting').style.display='none'; return; }
  $('#screen-reporting').style.display='block';
  const {status,data} = await api('/users', { method:'GET' });
  if(status!==200 || !data.ok){ $('#reportingTbody').innerHTML = ''; return; }
  const users = data.users;
  const tbody = $('#reportingTbody'); tbody.innerHTML = '';
  reportingAssignments = {};
  for(const u of users){
    const tr = document.createElement('tr');
    const options = users.map(v=>`<option value="${v.id}" ${u.reportingOfficerId===v.id?'selected':''}>${v.email}</option>`).join('');
    tr.innerHTML = `<td>${u.email}</td><td>${u.role}</td><td><select onchange="setRO('${u.id}', this.value)"><option value="">â€” None â€”</option>${options}</select></td>`;
    tbody.appendChild(tr);
  }
}
window.setRO = function(userId, roId){ reportingAssignments[userId] = roId || null; }
$('#btnSaveReporting').addEventListener('click', async ()=>{ const {status,data} = await api('/reporting', { method:'PUT', body: JSON.stringify({ assignments: reportingAssignments }) }); if(status===200 && data.ok) toast('Updated'); else toast('Error'); });

/* Admin */
async function renderAdmin(){
  if(!((PERMS[CURRENT_USER.role]||[]).includes('manage_permissions'))){ $('#screen-admin').style.display='none'; return; }
  $('#screen-admin').style.display='block';
  const {status:ps, data:pd} = await api('/permissions', { method:'GET' });
  const perms = (ps===200 && pd.ok) ? pd.perms : {};
  const ALL_PERMS = ['view_dashboard','apply_leave','approve_leave','assign_reporting','manage_permissions','manage_users'];
  const roles = Object.keys(perms).length ? Object.keys(perms) : ['Admin','HR','Finance','IT','Teacher','Employee'];
  let html = `<table style="width:100%"><thead><tr><th>Role</th>${ALL_PERMS.map(p=>`<th>${p}</th>`).join('')}</tr></thead><tbody>`;
  for(const role of roles){
    html += `<tr><td style="font-weight:700">${role}</td>`;
    for(const p of ALL_PERMS){
      const checked = (perms[role]||[]).includes(p) ? 'checked' : '';
      html += `<td><input type="checkbox" data-role="${role}" data-perm="${p}" ${checked}></td>`;
    }
    html += `</tr>`;
  }
  html += `</tbody></table>`;
  $('#permMatrix').innerHTML = html;

  const {status:us, data:ud} = await api('/users', { method:'GET' });
  const users = (us===200 && ud.ok) ? ud.users : [];
  const tbody = $('#usersTbody'); tbody.innerHTML = '';
  for(const u of users){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.email}</td><td><select onchange="changeRole('${u.id}', this.value)">${['Admin','HR','Finance','IT','Teacher','Employee'].map(r=>`<option ${u.role===r?'selected':''}>${r}</option>`).join('')}</select></td><td><button class="btn btn-danger" onclick="deleteUser('${u.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  }
}
$('#btnSavePerms').addEventListener('click', async ()=>{
  const checks = document.querySelectorAll('#permMatrix input[type=checkbox]');
  const next = {};
  checks.forEach(ch=>{ if(ch.checked){ const r=ch.dataset.role, p=ch.dataset.perm; (next[r]||(next[r]=[])).push(p); } });
  const {status,data} = await api('/permissions', { method:'PUT', body: JSON.stringify({ perms: next }) });
  if(status===200 && data.ok){ toast('Permissions saved'); loadPermissionsAndRender(); } else toast('Error');
});
window.changeRole = async function(userId, role){ const {status,data} = await api('/users/'+userId, { method:'PUT', body: JSON.stringify({ role }) }); if(status===200 && data.ok){ toast('Role updated'); if(userId===CURRENT_USER.id){ startApp(); } else renderAdmin(); } else toast('Error'); }
window.deleteUser = async function(userId){ if(!confirm('Delete user?')) return; const {status,data} = await api('/users/'+userId, { method:'DELETE' }); if(status===200 && data.ok){ toast('Deleted'); if(userId===CURRENT_USER.id) logout(); else renderAdmin(); } else toast('Error'); }

/* Profile */
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
$('#pfPhoto').addEventListener('change', async (e)=>{ const f = e.target.files[0]; if(!f) return; const url = await fileToDataURL(f); $('#pfPreview').src = url; });
function renderProfile(){ $('#pfName').value = CURRENT_USER.profile?.name || ''; $('#pfPhone').value = CURRENT_USER.profile?.phone || ''; $('#pfAddr').value = CURRENT_USER.profile?.address || ''; $('#pfPreview').src = CURRENT_USER.profile?.photo || `https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(CURRENT_USER.email)}`; }
$('#btnSaveProfile').addEventListener('click', async ()=>{ const payload = { name: $('#pfName').value.trim(), phone: $('#pfPhone').value.trim(), address: $('#pfAddr').value.trim(), photo: $('#pfPreview').src }; const {status,data} = await api('/profile', { method:'PUT', body: JSON.stringify(payload) }); if(status===200 && data.ok){ CURRENT_USER = data.user; toast('Profile saved'); renderProfile(); } else toast('Error'); });

/* ============== Login/Logout ============== */
$('#logoutBtn').addEventListener('click', ()=> logout());
function logout(){ localStorage.removeItem(authTokenKey); location.reload(); }

/* small helpers to keep UI sane if elements missing */
function safeId(id){ return document.getElementById(id) || { addEventListener(){}, value:'', classList:{}, style:{} }; }

/* expose some global functions used in inline onclicks */
window.openAuth = openAuth;

/* End of script */
</script>
</body>
</html>
